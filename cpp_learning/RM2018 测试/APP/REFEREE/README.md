# 裁判系统通讯说明 
update：2017.8.10 by 杨智宇
## 通讯协议
* 通讯协议按照官方PDF。其中信息分为两种，**固定频率帧**（如GameInfo）和**触发信息帧**（如RealBloodChangedData），具体信息参见当年官方说明。

## 信息接收和预处理
* 所有裁判信息存于`RefereeInfo.h`结构体中作为全局变量。
* C的数据类型与对应字节的互相转换使用union。
* 关于DMA接收数组中的信息撷取(按照DMA接收数组为固定长度)：
    1. DMA接收数组长度理论上应大于**固定频率帧长度**与所有**触发信息帧长度**之和。
    2. 首尾一次循环检测正确帧。
    3. **检测到正确帧时，改写帧头以破坏该帧(有同时写入风险)，以此标记该条信息已读。**

## 收发硬件设置
* 收发开启DMA通道。
* 接收使用循环模式，发送使用普通模式(usart6的发送循环模式开启失败。。。)。
* **建议考虑双缓存以避免对DMA接收数组的多方同时写入。**

## 接口说明
* 初始化相关结构体。
    ```c
    void init_referee_info(void) 
    ```

* 从DMA接收数组中更新相关结构体，调用即可刷新数据。
    ```c
    void update_from_dma(void)  // USART6_dma为全局DMA数组变量, 可修改为传入数组方式。
    ```

* 自定义数据帧生成。
    ```c
    void custom_frame_pack(uint8_t * custom_frame)
    ```
    `uint8_t * custom_frame`：生成的数据帧
## 注意事项
* 结构体记录的是最后一次更新，建议增加一成员变量来标记该结构体是否被读过。
* **触发信息帧**存在一定丢帧情况。17RM中，多块装甲板同时击打时容易丢失RealBloodChangedData，测速模块信息存在小几率丢失(接收结果：45/50)。

